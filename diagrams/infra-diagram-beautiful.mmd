%% Infra diagram — esthétique, centré sur l'infrastructure
%% Use in README or export as image (mmdc)

flowchart LR
  %% Left: GitLab CI
  subgraph gitlab ["GitLab CI (Synology NAS)"]
    direction TB
    GL["GitLab CI\n(push)\nvariables & artifacts"]
  end

  %% Middle: Runner
  RUN["Runner\n(Ansible)\nexecutes jobs"]

  %% Right: Infrastructure cluster
  subgraph infra ["Cluster Kubernetes — Infra view"]
    direction TB
    master["Master VM\n(control plane)\n(kube-apiserver)" ]
    runtime_master["containerd\n(runtime)"]
    network_master["Flannel CNI\n(pod CIDR)" ]
    ---
    worker1["Worker VM 1\n(kubelet)" ]
    runtime_w1["containerd"]
    network_w1["Flannel CNI"]
    ---
    worker2["Worker VM 2\n(kubelet)" ]
    runtime_w2["containerd"]
    network_w2["Flannel CNI"]
  end

  %% Services (minimal, secondary)
  dashboard["Kubernetes Dashboard\n(optional)"]

  %% Flows
  GL -->|push triggers pipeline| RUN
  RUN -->|Ansible SSH| master
  RUN -->|Ansible SSH| worker1
  RUN -->|Ansible SSH| worker2

  master --> dashboard
  worker1 --> dashboard
  worker2 --> dashboard

  %% Styling - focus on infra
  classDef gitlabStyle fill:#fef3c7,stroke:#d97706,stroke-width:1px;
  classDef runnerStyle fill:#eef2ff,stroke:#6366f1,stroke-width:1px;
  classDef nodeStyle fill:#ffffff,stroke:#0ea5a4,stroke-width:1px;
  classDef subStyle fill:#f8fafc,stroke:#94a3b8,stroke-width:1px,stroke-dasharray: 3 3;

  class GL gitlabStyle;
  class RUN runnerStyle;
  class master,worker1,worker2,runtime_master,runtime_w1,runtime_w2,network_master,network_w1,network_w2 nodeStyle;
  class infra subStyle;

  %% Legend
  LEGEND1["Legend:\n• GitLab CI → pipeline trigger\n• Runner executes Ansible to SSH into VMs\n• containerd = runtime; Flannel = CNI"]
  LEGEND1 -.-> infra

  %% Optional: artifacts link back to GitLab
  ART["Artifacts\n(kubeconfig, tokens)"]
  RUN --> ART
  ART --> GL
