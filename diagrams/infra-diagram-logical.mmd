%% Logical infra diagram (step-by-step)
%% Focus on the actual sequence of actions run by the pipeline/runner

flowchart TD
  Start([Start])

  GL["GitLab CI\n(push + variables)"]
  RUN["GitLab Runner\n(Ansible)"]

  Prep["1. Provision & prepare VMs\n(SSH key, users, prerequisites)"]
  Runtime["2. Install runtime on all nodes\n(containerd + cri-tools)"]
  KubePkg["3. Install kubeadm/kubelet/kubectl\n(on all nodes)"]

  MasterInit["4. Init Master\n(kubeadm init -> generates kubeconfig & join token)"]
  CNI["5. Install CNI (Flannel)\n(apply manifest on master)"]
  JoinCmd["Join command (token + discovery)\n(generated by master)"]
  WorkersJoin["6. Workers run kubeadm join\n(join to cluster)"]

  Verify["7. Verify cluster\n(kubectl get nodes, check pods)"]
  Deploy["8. Deploy apps & infra components\n(dashboard, monitoring optional)"]
  End([Done])

  %% Flows (logical sequence)
  Start --> GL
  GL --> RUN
  RUN --> Prep
  Prep --> Runtime
  Runtime --> KubePkg

  KubePkg --> MasterInit
  MasterInit --> CNI
  MasterInit --> JoinCmd

  CNI --> Verify
  JoinCmd --> WorkersJoin
  WorkersJoin --> Verify

  Verify --> Deploy
  Deploy --> End

  %% Parallel arrows showing "applies to all nodes"
  Runtime -.->|applies to| MASTER_NODE["Master Node"]
  Runtime -.->|applies to| WORKER1_NODE["Worker Node 1"]
  Runtime -.->|applies to| WORKER2_NODE["Worker Node 2"]

  KubePkg -.-> MASTER_NODE
  KubePkg -.-> WORKER1_NODE
  KubePkg -.-> WORKER2_NODE

  MasterInit -.-> MASTER_NODE
  WorkersJoin -.-> WORKER1_NODE
  WorkersJoin -.-> WORKER2_NODE

  classDef step fill:#f8fafc,stroke:#0f172a,stroke-width:1px;
  class Prep,Runtime,KubePkg,MasterInit,CNI,WorkersJoin,Verify,Deploy step;

  classDef infraNode fill:#ffffff,stroke:#0ea5a4,stroke-width:1px;
  class MASTER_NODE,WORKER1_NODE,WORKER2_NODE infraNode;

  %% Notes
  note right of RUN
    Runner executes Ansible playbooks:
    - prepare VMs
    - install runtime & packages
    - run kubeadm init/join
  end note

  note left of Deploy
    Optional: Prometheus/Grafana (external or in-cluster)
  end note
